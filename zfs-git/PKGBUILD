# Maintainer: Jesus Alvarez <jeezusjr at gmail dot com>
# Contributor: Kyle Fuller <inbox at kylefuller dot co dot uk>
# See http://github.com/demizer/archzfs for build scripts.

pkgname="zfs-git"
pkgver=
pkgrel=1

# Used incase the i686 and x86_64 linux packages get out of sync with the
# PKGREL. This occurred on January 31, 2014 where i686 was versioned at
# 3.12.9-1 and x86_64 was versioned at 3.12.9-2.
_kernel_version_x32="3.14-4"
_kernel_version_x32_clean="3.14.0_4"
_kernel_version_x32_full="3.14.0-4"
_kernel_version_x64="3.14-4"
_kernel_version_x64_clean="3.14.0_4"
_kernel_version_x64_full="3.14.0-4"

if [[ $CARCH == "i686" ]]; then
    _kernel_version=${_kernel_version_x32}
    _kernel_version_clean=${_kernel_version_x32_clean}
    _kernel_version_full=${_kernel_version_x32_full}
else
    _kernel_version=${_kernel_version_x64}
    _kernel_version_clean=${_kernel_version_x64_clean}
    _kernel_version_full=${_kernel_version_x64_full}
fi

pkgdesc="Kernel modules for the Zettabyte File System."
depends=("spl=0.6.2_3.14-2" "zfs-utils" "linux=${_kernel_version}")
makedepends=("git" "linux-headers=${_kernel_version}")
arch=("i686" "x86_64")
url="http://zfsonlinux.org/"
source=(git+https://github.com/zfsonlinux/zfs.git)
groups=("archzfs")
md5sums=('SKIP')
license=("CDDL")
install=zfs.install

build() {
    cd "${srcdir}/zfs"
    ./autogen.sh

    ./configure --prefix=/usr \
                --sysconfdir=/etc \
                --sbindir=/usr/bin \
                --libdir=/usr/lib \
                --datadir=/usr/share \
                --includedir=/usr/include \
                --with-udevdir=/lib/udev \
                --libexecdir=/usr/lib/zfs \
                --with-config=kernel \
                --with-linux=/usr/lib/modules/${_kernel_version_full}-ARCH/build

    make
}

package() {
    cd "${srcdir}/zfs"
    make DESTDIR="${pkgdir}" install
    # move module tree /lib -> /usr/lib
    # cp -r "$pkgdir"/{lib,usr}
    # rm -r "$pkgdir"/lib
}
